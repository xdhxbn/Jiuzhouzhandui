#中期考核文档
=============
## PS2通信模块
=====
  功能描述：该模块用于实现PS2接收器与stm32主板之间的通讯功能。为了保证通讯的实时性，决定采用非阻塞式编程，即通过计时器中断来按时与手柄通信，以免出现卡在程序某处导致不能及时接收信息的情况。后续迭代升级的计划是采用spI硬件自动通信并且用DMA自动转存PS2数据到结构体中，既节约软件资源，又提高了传输速度。<br>

=====
  开发历程：<br>
    10月9日：初期方案：<br>
    初期讨论后准备采用用软件模拟SPI通信，在主程序中调用PS2通信函数更新PS2结构体，再根据PS2结构体数据调整外设。
    后来为规范程序设计，方便合作，规定每个外设对应的模块设计一个对接PS2的函数，每个外设通过该函数从ps2中获得需要的数据存入自己的
    结构体中，再调用根据自己结构体调整自己的外设的函数，奠定了主程序框架的基础。<br>
    10月9日：遇到的问题之一：<br>
    首先是在写PS2通信函数的时候遭遇了问题。由于跟着江科大学的是标准库，群里的代码没法照搬，就开始着手写PS2通信程序。遇到的第一个
    问题是，由于以为SPI通讯外设都和江科大讲的一样，在最开始无论如何都无法实现通信，接收器也连不上。<br>
    10月9日：解决方案：<br>
    首先找客服搞清楚接收器闪烁代表什么。根据客服消息，确定了是程序没写对。之后找客服要数据手册，想办法搞明白了时序图的含义和一些表格
    的意思，明白了每个SPI外设虽然大体上通讯逻辑一样但一些细节，如从高位开始发送还是从低位开始发送，是不一样的，搞明白这个PS2手柄的通
    讯方式后成功解决了这个问题。<br>
    10月10日：遇到的问题之二：<br>
    在主程序的while()循环中的某个固定的位置调用PS2通信函数，虽然暂时没什么问题，但是随着主程序中运行的代码越来越多，可能不能及时地接
    收手柄的信息，不利于小车迭代升级，也不能保证通信的实时性。<br>
    10月10日：解决方案：<br>
    决定用定时器中断的方式，使用定时器，每过10ms就发起一次中断，进行与PS2的通信，这样保证了PS2通信的畅通，确保小车及时做出调整。<br>
    10月23日：下一步迭代优化方案：<br>
    经过学习，提出采用spI硬件自动通信并且用DMA自动转存PS2数据到结构体中，既节约软件资源，又极大的提升了传输速度，
    预计在二代机中实现。<br>

## 麦轮运动系统模块
=====
  功能描述：该模块用于实现通过PS2控制小车的方向，旋转以及运动速度。虽然理论上可以实现走任意角度斜线的功能，但是苦于定时器资源不够只能舍弃一部分功能，但是转向，上下左右平移，调控速度都没问题。<br>
  
=====
  开发历程：<br>
  10月13日：初期方案：<br>
    依照预定的框架，由小及大定义结构体，先定义了单个轮子的结构体，并写了控制轮子正转，反转和停止的函数，由于定时器有限就四个轮子统一一个速度，
    并将四个轮子结构体和方向参数，旋转参数和速度参数一起封装成了运动系统结构体，编写对应的初始化函数，读取PS2函数与调整外设函数，实现PS2传递
    信息给运动系统，运动系统控制轮子的分级控制结构，虽然这个过程显得有点拐来拐去的，但是便于之后修改代码和实现小车的迭代升级，比如万一要改引
    脚的话就改一下结构体初始化函数就好了，而且整个过程的思路会清楚一些。<br>
  10月13日：遇到的问题之一：<br>
    首先遇到了如何用手柄控制小车的速度与运动方式的问题，要求手柄对小车的控制要灵活并易于操作。<br>
  10月13日：解决方案：<br>
    我们想让小车可以调整一下速度的快慢，一个方案是通过上下左右的按键控制，按一下对应的方向键就向对应的方向加速，但是感觉太笨重了，于是想这研究
    一下摇杆，在搞清楚摇杆数据的原理之后，就开始着手制定控制的规则，原本想设计一个根据可以按照x与y的比例走任意方向的方案，但是由于外设不足只好
    放弃。经过讨论，左摇杆x方向的位移大小和y方向的位移大小谁大，就认为小车是在沿哪个轴运动，并且依据该方向上的位移，以一定比例放大，来调整PWM的
    占空比，从而调整速度。用右摇杆控制旋转方向，当x方向无位移时认为不旋转，右摇杆向右偏就是以顺时针转反之逆时针，速度由x方向偏移大小决定，且旋
    转命令的优先级大于平动命令。<br>
  10月14日：遇到的问题之二：<br>
    原本想直接通过运动结构体来调整运动，但是想到如果保持相同运动状态的话每次都要设置相同的参数太浪费软件资源了。<br>
  10月14日：解决方案：<br>
    在程序中设置了两个运动结构体，分别为car_now,car_last，最开始二者相同，随后开始将需要的PS2数据存入now中，之后进入调整运动的函数时，比较now
    与last中的数据是否一致，相同的话就不改，不同再改，且设计了运动状态时间的过渡状态，比如说，发现last表明之前小车再转动，会先停止转动，再重新配
    置，又比如如果last是向前转，now是反转，就先让电机停下来，再设置方向速度，避免在电机快速旋转时突然改变极性可能的对电机和电路的损伤，之后再把
    now中的数据转移到last来。<br>
  10月14日：下一步迭代优化方案：<br>
    会在测试中研究合适的占空比与算法，让运动过渡更平稳，起步更快，刹车更及时灵敏等。<br>


## 收集模块

<img width="864" height="496" alt="image" src="https://github.com/user-attachments/assets/6b6bb0c3-9933-4032-a8aa-aa344299bbec" />

=====
  功能描述：利用马达带动水车装置旋转，实现对小球的收集，利用斜坡作为导轨将被弹起的小球送到仓库。<br>
  
=====
  开发历程：<br>
  10月13日：初步设计思路：因为小车会有上下坡的动作，斜坡的存在会使小车整体被卡住，因此我们设计了伸缩结构的收集装置<br>
  10月14日到10月17日：迭代优化方案：就伸缩结构而言，第一代方案是利用齿轮齿条的传动作用将整个收集装置上下收缩移动，但是考虑到结构复杂以及容易卡住，第二代方案我们换成了利用两个舵机实现对收集装置的抬升，随后又还是觉得麻烦，所以我们的第三代收集装置是利用一个TT马达牵引两根线，直接对斜坡进行抬升。

  
## 转移装置模块

<img width="690" height="312" alt="image" src="https://github.com/user-attachments/assets/de4027d8-9181-45ca-93d5-ac78210e77c6" />
=====
  功能描述：MG995舵机固连仓库，舵机90°翻转实现仓库的倾倒功能；马达带动齿轮旋转，经齿条转化为平动实现仓库上升和下降的功能。<br>
    
=====
  开发历程：<br>
 10月19日初步方案：第一代转移装置是直接利用舵机将仓库倾倒，问题在于此转移装置实现的前提（能够将2号小车里面的小球转移到1号小车）是仓库足够的高，考虑到仓库足够的高的话对收集装置的设计会比较困难。
  10月20日到10月22日迭代优化方案：第二代方案我们换成了利用两个舵机实现对收集装置的抬升，随后又还是觉得麻烦，所以我们的第三代收集装置是利用一个TT马达牵引两根线，直接对斜坡进行抬升。
  
## 机械臂模块

<img width="864" height="496" alt="image" src="https://github.com/user-attachments/assets/f53b0147-44ac-42c4-bb3e-dcf3fb33fa2c" />

<img width="539" height="718" alt="image" src="https://github.com/user-attachments/assets/07f26611-21f8-4688-9a03-9434cc9cd3ce" />
<br>
=====
  功能描述：此机械臂拥有两大功能，一是实现对台阶上的小球的扒拉作用，二是实现对敌方小车的阻挡作用。<br>
    
=====
  开发历程：
  10月23日到10月24日：构思并建模。
## 主程序操作系统模块
===== 
  功能描述：优化小车的工作模式，充分利用小车的硬件资源。<br>
    
=====
  开发历程：<br>
  10月8日：遇到的问题一:<br>
  如何实现各模块之间的独立编写与协同合作。<br>
  解决方案：<br>
  经过讨论，主程序不直接参与硬件设置，每个模块设置了几个接口函数负责数据的传输，具体的硬件控制的功能在接口函数中调用该模块对应函数实现。各个模块的负责人将相关函数编好打包为头文件，上传到工程中<br>
  10月8日：遇到的问题二：<br>
  有人学HAL库，有人学标准库，用的库不统一。<br>
  解决方案：<br>
  由于HAL库有系统自动生成的代码，不清楚原理的话不太好把这个模块打包为头文件，可能会缺点什么东西，又考虑到标准库有点繁琐，就手动把标准库一些常用功能分装打包成便于调用的函数，比如gpio口的配置，定时器的配置等，这样就可以降低标准库的使用难度，便于合作，统一标准。<br>
  10月23日：遇到的问题三：<br>
  在进行机械臂等需要舵机的外设的编程时，发现定时器不够用的问题。<br>
  解决方案：<br>
  从SPI软件模拟获得启发，结合延时函数，用软件模拟需要的PWM波形。<br>
  10月25日：遇到的问题四：<br>
  在把机械臂等模块并入主程序时，发现小车死机了，经过debug，发现问题在延时函数上。<br>
  解决方案：<br>
  经过debug发现，PS_EXIT_INIT()之后的不在中断里的延时函数都会让程序崩溃，查阅资料后，发现基于硬件的延时函数不能和中断同时使用。于是重写了一个基于软件的延时函数，解决了该问题，并记住了这个教训。<br>
